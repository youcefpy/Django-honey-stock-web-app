{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %} REMPLIRE DES COFFERT {% endblock %}

{% block content %}
  <h2>REMPLIRE DES COFFERT</h2>

  {% if messages %}
    <div class="messages">
        {% for message in messages %}
          <div{% if message.tags %} class="{{ message.tags }}"{% endif %} style="color:red" >{{ message }}</div>
        {% endfor %}
    </div>
  {% endif %}


  <form method="post" class='needs-validation' novalidate>
    {% csrf_token %}
    {% for field in form %}
      <div class='form-group'>
        
        {% if field.name != "sku_id" %}
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        {% endif %}
        
        {% if field.name == "sku_code" %}
            {{ field|add_class:"form-control sku-search" }}
            <div id="skuDropdown" style="display:none; border: 1px solid #aaa; max-height: 200px; overflow-y: auto;"></div>
        {% elif field.name == "box_type" %}
            {{ field|add_class:"form-control"|attr:"onchange=updateJars();" }}
            <div id="honey_selects">
                <!-- Honey selects will be appended here by JavaScript -->
            </div>
        {% else %}
            {{ field|add_class:"form-control" }}
        {% endif %}
    
        <div class="invalid-feedback">
          {{ field.errors|striptags }}
        </div>
      </div>
  {% endfor %}
  
    <button type="submit" class='btn btn-success'>Valid√©</button>
  </form>
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
      $(document).ready(function() {
          $(".sku-search").on('input', function() {
              const query = $(this).val();
              if (query.length) {
                  $.get('/api/skus/', { q: query }, function(data) {
                      $("#skuDropdown").empty();
                      data.forEach(sku => {
                          $("#skuDropdown").append(`<div class="skuItem" data-id="${sku.id}">${sku.code}</div>`);
                      });
                      $("#skuDropdown").show();
                  });
              } else {
                  $("#skuDropdown").hide();
              }
          });

          $("#skuDropdown").on('click', '.skuItem', function() {
              const selectedSku = $(this).text();
              const selectedSkuId = $(this).data("id");
              $(".sku-search").val(selectedSku);  // set visible input
              $("input[name='sku_id']").val(selectedSkuId);  // set hidden input with SKU ID
              $("#skuDropdown").hide();
          });
      });
  </script>
<script>
  function updateJars() {
    var boxType = document.getElementById('id_box_type').value;
    var honeyDiv = document.getElementById('honey_selects');
    
    // Clear existing selects
    honeyDiv.innerHTML = '';
    console.log("Box type changed");
    
    fetch('/get_jars/?box_type=' + boxType)
        .then(response => response.json())
        .then(data => {
            var numSelects = data.num_jars;
            var jars = data.filled_jars;
            
            for (var i = 0; i < numSelects; i++) {
                var label = document.createElement('label');
                label.textContent = 'Miel' + (i+1);
                label.classList.add('d-block', 'mb-1')
                honeyDiv.appendChild(label);
    
                var select = document.createElement('select');
                select.name = jars[i].name.replace(' ', '_') + '_' + jars[i].size;
                select.classList.add('form-control', 'mb-2');
                select.classList.add('mt-1');
    
                jars.forEach(jar => {
                    var option = document.createElement('option');
                    option.value = jar.id;
                    option.textContent = jar.name + ' (' + jar.size + ' KG)';
                    select.appendChild(option);
                });
    
                honeyDiv.appendChild(select);
                honeyDiv.appendChild(document.createElement('br'));
            }
        });
    }
</script>
{% endblock %}
